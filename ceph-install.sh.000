#!/bin/bash
. `dirname $0`/prompt.inc || exit 1

[ "`whoami`" = "cephuser" ] || abort "must be run as cephuser"

###

setup_host()
{
	H="$1"
	[ -z "$H" ] && return
	echo "========== $H =========="
	IP="`host $H | awk '/ has address / { print $NF }'`"
	grep $H /etc/hosts > /dev/null || echo "$IP    $H" | sudo tee -a /etc/hosts

	[ -f ~/.ssh/config ]  || touch ~/.ssh/config
	grep "^Host $H" ~/.ssh/config > /dev/null || printf "Host $H\n\tHostname $H\n\tUser cephuser\n\n" >> ~/.ssh/config
	chmod 644 ~/.ssh/config

	[ -f ~/.ssh/known_hosts ] || touch ~/.ssh/known_hosts
	grep "^$H" ~/.ssh/known_hosts > /dev/null || ssh-keyscan $H >> ~/.ssh/known_hosts

	ssh-copy-id $H
}

############## MAIN ###########
NAME="`hostname -s`"

TYPE="`echo $NAME | sed -e 's|^ceph-\([a-z]*\)[0-9]*|\1|g'`"
[ -z "$TYPE" ] && abort "Null ceph-typeX fron NAME[$NAME]"
prompt "Ceph ($TYPE) Install ceph on [$NAME]?"

## common
[ -f ~/.ssh/id_rsa ] || ssh-keygen -N "" -f ~/.ssh/id_rsa
[ -f ~/.install.setup.noipv6 ] || /data/nfs/linux/disable-ipv6.sh > ~/.install.setup.noipv6
if [ ! -f /etc/yum.repos.d/ceph.repo ]; then
	cp -p `dirname $0`/ceph.repo /etc/yum.repos.d/ceph.repo
	yum -y update
fi

## admin
if [ "$TYPE" = "admin" ]; then
	if [ ! -f ~/.install.setup.hosts ]; then
		print "setting up ssh keys.."
		for H in ceph-admin ceph-mon1 ceph-osd1 ceph-osd2 ceph-osd3; do
			setup_host $H
		done > ~/.install.setup.hosts
	fi

	
	if [ ! -f ~/.install.setup.fw ]; then
		print "fw rules.."
		sudo firewall-cmd --zone=public --add-port=80/tcp --permanent
		sudo firewall-cmd --zone=public --add-port=2003/tcp --permanent
		sudo firewall-cmd --zone=public --add-port=4505-4506/tcp --permanent
		sudo firewall-cmd --reload
		touch ~/.install.setup.fw
	fi

	rpm -q epel-release > /dev/null || sudo yum -y install epel-release
	rpm -q yum-plugin-priorities || sudo yum -y install yum-plugin-priorities
	rpm -q python-setuptools || sudo yum -y install python-setuptools

	[ -f  /etc/yum.repos.d/ceph.repo ] || cat | sudo tee /etc/yum.repos.d/ceph.repo  << EOFrepo 
[ceph-noarch]
name=Ceph noarch packages
baseurl=https://download.ceph.com/rpm-luminous/el7/noarch
enabled=1
gpgcheck=0
type=rpm-md
#gpgkey=https://download.ceph.com/keys/release.asc
EOFrepo

	rpm -q ceph-deploy || (
		set -x
		sudo yum -y update
		sudo yum -y install ceph-deploy
		set +x
	)

fi


## mon
if [ "$TYPE" = "mon" ]; then
	if [ ! -f ~/.install.setup.fw ]; then
		print "fw rules.."
		sudo firewall-cmd --zone=public --add-port=6789/tcp --permanent
		sudo firewall-cmd --reload
		touch ~/.install.setup.fw
	fi

fi

## osd
if [ "$TYPE" = "osd" ]; then
	if [ ! -f ~/.install.setup.fw ]; then
		print "fw rules.."
		sudo firewall-cmd --zone=public --add-port=6800-7300/tcp --permanent
		sudo firewall-cmd --reload
		touch ~/.install.setup.fw
	fi

	if [ ! -f ~/.install.setup.fdisk ]; then
		print "fdisk.."
		DISK=/dev/vdb
		set -x
		sudo parted -s $DISK mklabel gpt mkpart primary xfs 0% 100%
		sudo mkfs.xfs $DISK -f
		sudo blkid -o value -s TYPE $DISK
		set +x
		touch ~/.install.setup.fdisk
	fi
fi
